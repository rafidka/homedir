#!/bin/bash

# Help function
show_help() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS] [directory]

Remove Python development artifacts from a directory tree.

Arguments:
    directory       Directory to clean (default: current directory)

Options:
    -h, --help      Show this help message and exit
    -d, --dry-run   Show what would be deleted without removing
    -f, --force     Skip confirmation prompt
    -v, --verbose   Show detailed output

Description:
    Recursively removes Python development artifacts including:
    - .venv/ directories
    - __pycache__ directories  
    - .pytest_cache/ directories
    - poetry_install.log files
    - *.pyc files
    - .coverage files
    - *.egg-info directories

Examples:
    $(basename "$0")                    # Clean current directory
    $(basename "$0") ~/projects/myapp   # Clean specific directory
    $(basename "$0") --dry-run          # Preview what would be deleted
    $(basename "$0") -f                 # Skip confirmation

EOF
    exit 0
}

# Parse arguments
DRY_RUN=false
FORCE=false
VERBOSE=false
TARGET_DIR="."

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            ;;
        -d|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -*)
            echo "Error: Unknown option $1" >&2
            echo "Use --help for usage information" >&2
            exit 1
            ;;
        *)
            TARGET_DIR="$1"
            shift
            ;;
    esac
done

# Validate directory
if [[ ! -d "$TARGET_DIR" ]]; then
    echo "Error: Directory '$TARGET_DIR' does not exist" >&2
    exit 1
fi

# Convert to absolute path
TARGET_DIR=$(cd "$TARGET_DIR" && pwd)

# Function to delete or preview deletion
delete_item() {
    local item="$1"
    local type="$2"
    
    if [[ "$DRY_RUN" == true ]]; then
        echo "[DRY-RUN] Would remove $type: $item"
    else
        if [[ "$VERBOSE" == true ]]; then
            echo "Removing $type: $item"
        fi
        rm -rf "$item"
    fi
}

# Count items to be deleted
count_items() {
    local count=0
    
    # Count directories
    while IFS= read -r -d '' dir; do
        ((count++))
    done < <(find "$TARGET_DIR" -type d \( -name ".venv" -o -name "__pycache__" -o -name ".pytest_cache" -o -name "*.egg-info" \) -print0 2>/dev/null)
    
    # Count files
    while IFS= read -r -d '' file; do
        ((count++))
    done < <(find "$TARGET_DIR" -type f \( -name "poetry_install.log" -o -name "*.pyc" -o -name ".coverage" \) -print0 2>/dev/null)
    
    echo $count
}

# Get confirmation unless forced or dry-run
if [[ "$FORCE" != true ]] && [[ "$DRY_RUN" != true ]]; then
    ITEM_COUNT=$(count_items)
    
    if [[ $ITEM_COUNT -eq 0 ]]; then
        echo "No Python artifacts found to clean in $TARGET_DIR"
        exit 0
    fi
    
    echo "Found $ITEM_COUNT Python artifacts in $TARGET_DIR"
    read -p "Remove all Python development artifacts? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Operation cancelled."
        exit 0
    fi
fi

echo "Cleaning Python artifacts in: $TARGET_DIR"

# Remove directories
echo "Searching for directories to remove..."

# .venv directories
while IFS= read -r -d '' dir; do
    delete_item "$dir" ".venv directory"
done < <(find "$TARGET_DIR" -type d -name ".venv" -print0 2>/dev/null)

# __pycache__ directories
while IFS= read -r -d '' dir; do
    delete_item "$dir" "__pycache__ directory"
done < <(find "$TARGET_DIR" -type d -name "__pycache__" -print0 2>/dev/null)

# .pytest_cache directories
while IFS= read -r -d '' dir; do
    delete_item "$dir" ".pytest_cache directory"
done < <(find "$TARGET_DIR" -type d -name ".pytest_cache" -print0 2>/dev/null)

# *.egg-info directories
while IFS= read -r -d '' dir; do
    delete_item "$dir" ".egg-info directory"
done < <(find "$TARGET_DIR" -type d -name "*.egg-info" -print0 2>/dev/null)

# Remove files
echo "Searching for files to remove..."

# poetry_install.log files
while IFS= read -r -d '' file; do
    delete_item "$file" "poetry_install.log file"
done < <(find "$TARGET_DIR" -type f -name "poetry_install.log" -print0 2>/dev/null)

# *.pyc files
while IFS= read -r -d '' file; do
    delete_item "$file" ".pyc file"
done < <(find "$TARGET_DIR" -type f -name "*.pyc" -print0 2>/dev/null)

# .coverage files
while IFS= read -r -d '' file; do
    delete_item "$file" ".coverage file"
done < <(find "$TARGET_DIR" -type f -name ".coverage" -print0 2>/dev/null)

if [[ "$DRY_RUN" == true ]]; then
    echo "Dry run complete. No files were actually removed."
else
    echo "âœ“ Python cleanup complete."
fi